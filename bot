const qrcode = require("qrcode-terminal");
const { Client, Buttons, List, MessageMedia } = require("whatsapp-web.js");
const client = new Client();

const delay = (ms) => new Promise((res) => setTimeout(res, ms)); // FunÃ§Ã£o para criar atraso

// Escutando o QR Code
client.on("qr", (qr) => {
  qrcode.generate(qr, { small: true });
});

// Confirmando conexÃ£o
client.on("ready", () => {
  console.log("âœ… WhatsApp conectado com sucesso!");
});

// Inicializa o cliente
client.initialize();

// Funil de mensagens
client.on("message", async (msg) => {
  try {
    // Exibir menu inicial
    if (
      /(menu|Tudo bem|Menu|Bom dia|Boa tarde|Boa noite|oi|Oi|OlÃ¡|olÃ¡|ola|Ola)/i.test(msg.body) &&
      msg.from.endsWith("@c.us")
    ) {
      const chat = await msg.getChat();
      await chat.sendStateTyping(); // Indicando digitaÃ§Ã£o
      await delay(3000);

      const contact = await msg.getContact();
      const name = contact.pushname || "Cliente";

      await client.sendMessage(
        msg.from,
        `OlÃ¡, ${
          name.split(" ")[0]
        }! ğŸ‘‹ Sou o assistente virtual da nossa Loja de IPTV.\n\n` +
          `Por favor, escolha uma opÃ§Ã£o abaixo:\n\n` +
          `1ï¸âƒ£ - Planos e preÃ§os\n` +
          `2ï¸âƒ£ - Como funciona\n` +
          `3ï¸âƒ£ - Teste grÃ¡tis\n` +
          `4ï¸âƒ£ - Suporte tÃ©cnico\n` +
          `5ï¸âƒ£ - Outras dÃºvidas`
      );
    }

    // OpÃ§Ãµes do menu
    if (msg.body === "1" && msg.from.endsWith("@c.us")) {
      const chat = await msg.getChat();
      await chat.sendStateTyping();
      await delay(3000);

      await client.sendMessage(
        msg.from,
        `ğŸ“º *Planos de IPTV*\n\n` +
          `âœ… Mensal: R$ 30,00\n` +
          `âœ… Trimestral: R$ 80,00\n` +
          `âœ… Anual: R$ 250,00\n\n` +
          `ğŸ”— *Adquira agora*: https://site.com`
      );
    }

    if (msg.body === "2" && msg.from.endsWith("@c.us")) {
      const chat = await msg.getChat();
      await chat.sendStateTyping();
      await delay(3000);

      await client.sendMessage(
        msg.from,
        `ğŸ› ï¸ *Como funciona o IPTV*\n\n` +
          `1ï¸âƒ£ Escolha um plano.\n` +
          `2ï¸âƒ£ Pague via Pix ou cartÃ£o.\n` +
          `3ï¸âƒ£ Receba acesso e instruÃ§Ãµes.\n\n` +
          `ğŸ”— Comece agora: https://site.com`
      );
    }

    if (msg.body === "3" && msg.from.endsWith("@c.us")) {
      const chat = await msg.getChat();
      await chat.sendStateTyping();
      await delay(3000);

      await client.sendMessage(
        msg.from,
        `ğŸ¯ *Teste grÃ¡tis disponÃ­vel!*\n\n` +
          `âœ… Receba 24 horas de acesso grÃ¡tis.\n\n` +
          `Para solicitar, envie: *#testegrÃ¡tis*`
      );
    }

    if (msg.body === "4" && msg.from.endsWith("@c.us")) {
      const chat = await msg.getChat();
      await chat.sendStateTyping();
      await delay(3000);

      await client.sendMessage(
        msg.from,
        `ğŸ”§ *Suporte TÃ©cnico*\n\n` +
          `Explique seu problema e nossa equipe ajudarÃ¡ vocÃª.`
      );
    }

    if (msg.body === "5" && msg.from.endsWith("@c.us")) {
      const chat = await msg.getChat();
      await chat.sendStateTyping();
      await delay(3000);

      await client.sendMessage(
        msg.from,
        `ğŸ“© *Outras DÃºvidas*\n\n` +
          `Entre em contato conosco aqui ou acesse: https://site.com`
      );
    }
  } catch (error) {
    console.error("Erro ao processar mensagem:", error);
  }
});
